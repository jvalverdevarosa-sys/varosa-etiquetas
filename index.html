<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Etiquetas VAROSA</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
    :root{
        /* Colores corporativos VAROSA */
        --varosa-azul-oscuro: #1a365d;
        --varosa-azul: #2563eb;
        --varosa-cyan: #0891b2;
        --varosa-cyan-light: #22d3ee;
        --varosa-gris: #64748b;
        --varosa-gris-light: #f1f5f9;

        --label-width: 101.6mm;
        --label-height: 50.8mm;
        --padding: 2mm;
        --label-top-safe: 3mm; /* margen extra superior dentro de la etiqueta */
    }

    @page{
        size: var(--label-width) var(--label-height);
        margin: 0;
    }

    *{
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    html, body{
        width: 100%;
        height: 100%;
        font-family: 'Segoe UI', Arial, Helvetica, sans-serif;
    }

    /* ======== SOLO PANTALLA ======== */
    @media screen{
        body{
            background: linear-gradient(135deg, #1a365d 0%, #0891b2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .controles{
            background: #fff;
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,.2);
            margin-bottom: 24px;
            max-width: 500px;
            width: 100%;
        }
        .controles-header{
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .logo-text{
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--varosa-azul-oscuro) 0%, var(--varosa-cyan) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .controles h2{
            font-size: 16px;
            color: var(--varosa-gris);
            font-weight: normal;
        }
        .controles p{
            font-size: 13px;
            color: #64748b;
            margin-bottom: 16px;
            padding: 10px 12px;
            background: var(--varosa-gris-light);
            border-radius: 8px;
        }
        .controles button{
            background: linear-gradient(135deg, var(--varosa-azul-oscuro) 0%, var(--varosa-cyan) 100%);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .controles button:hover{
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.4);
        }
        .config-box{
            font-size: 11px;
            margin-top: 16px;
            background: #ecfeff;
            padding: 10px 12px;
            border-radius: 8px;
            border-left: 3px solid var(--varosa-cyan);
            color: var(--varosa-azul-oscuro);
        }
        .etiquetas-container{
            display: flex;
            flex-direction: column;
            gap: 24px;
            align-items: center;
        }
        .etiqueta-wrapper{
            box-shadow: 0 8px 30px rgba(0,0,0,.25);
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        .etiqueta-label{
            background: linear-gradient(135deg, var(--varosa-azul-oscuro) 0%, var(--varosa-cyan) 100%);
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            text-align: center;
        }
    }

    /* ======== SOLO IMPRESI√ìN ======== */
    @media print{
        body{
            background: #fff !important;
            padding: 0;
        }
        .controles,
        .etiqueta-label{
            display: none !important;
        }
        .etiquetas-container{
            display: block;
        }
        .etiqueta-wrapper{
            width: var(--label-width);
            height: var(--label-height);
            page-break-after: always;
            box-shadow: none;
        }
        .etiqueta-wrapper:last-child{
            page-break-after: avoid;
        }
    }

    /* ======== DISE√ëO DE LA ETIQUETA ======== */
    .etiqueta{
        width: var(--label-width);
        height: var(--label-height);
        padding: var(--padding);
        padding-top: calc(var(--padding) + var(--label-top-safe)); /* baja todo el contenido */
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    /* Header con banda de color */
    .header{
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-bottom: 1.5mm;
        border-bottom: 0.6mm solid var(--varosa-azul-oscuro);
        margin-bottom: 1.5mm;
    }

    .header-left{
        display: flex;
        flex-direction: column;
    }

    .empresa{
        font-size: 5mm;
        font-weight: 800;
        color: var(--varosa-azul-oscuro);
        letter-spacing: 0.5mm;
    }

    .documento{
        font-size: 3.8mm;
        font-weight: 800;
        color: var(--varosa-cyan);
    }

    .fecha-hora{
        font-size: 2.4mm;
        color: #111827;
        margin-top: 0.3mm;
        font-weight: 600;
    }

    .header-right{
        text-align: right;
    }

    .bultos-box{
        display: flex;
        gap: 0;
    }

    .bulto-item{
        border: 0.4mm solid var(--varosa-azul-oscuro);
        padding: 0.8mm 2mm;
        text-align: center;
        min-width: 11mm;
        background: #fff;
    }

    .bulto-item:first-child{
        border-right: none;
        border-radius: 1mm 0 0 1mm;
    }

    .bulto-item:last-child{
        border-radius: 0 1mm 1mm 0;
        background: var(--varosa-azul-oscuro);
    }

    .bulto-item:last-child small,
    .bulto-item:last-child .numero{
        color: #fff;
    }

    .bulto-item small{
        display: block;
        font-size: 1.8mm;
        color: var(--varosa-gris);
        font-weight: 600;
    }

    .bulto-item .numero{
        font-size: 5mm;
        font-weight: 800;
        line-height: 1;
        color: var(--varosa-azul-oscuro);
    }

    /* Cuerpo: INFO + QR */
    .body{
        display: flex;
        flex: 1;
        gap: 2mm;
    }

    /* Lado izquierdo: datos */
    .info{
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-width: 0;
    }

    .campo{
        margin-bottom: 0.8mm;
    }

    .campo-label{
        font-size: 2.4mm;
        color: #111827;
        text-transform: uppercase;
        letter-spacing: 0.2mm;
        font-weight: 700;
    }

    .campo-valor{
        font-size: 3.4mm;
        font-weight: 700;
        color: #000;
        line-height: 1.25;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .campo-valor.cliente{
        font-size: 3.6mm;
        font-weight: 700;
        color: #000;
    }

    .campo-valor.ruta{
        font-size: 3mm;
        background: var(--varosa-azul-oscuro);
        color: #fff;
        padding: 1mm 2mm;
        border-radius: 1mm;
        display: inline-block;
        font-weight: 600;
    }

    .notas{
        font-size: 2.6mm;
        color: #b91c1c;
        background: #fef2f2;
        padding: 1.2mm 2mm;
        border-radius: 1mm;
        border-left: 0.6mm solid #ef4444;
        margin-top: 1mm;
        font-weight: 500;
    }

    .notas.hidden{
        display: none;
    }

    /* Lado derecho: QR */
    .qr-section{
        width: 24mm;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-left: 0.3mm dashed #cbd5e1;
        padding-left: 2mm;
    }

    .qr-code{
        width: 20mm;
        height: 20mm;
    }

    .qr-code img,
    .qr-code canvas{
        width: 100% !important;
        height: 100% !important;
    }

    .qr-text{
        font-size: 1.8mm;
        color: varosa-gris;
        margin-top: 0.8mm;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.2mm;
    }

    /* Footer: Alistador */
    .footer{
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 0.3mm solid #e2e8f0;
        padding-top: 1mm;
        margin-top: auto;
        font-size: 2.4mm;
    }

    .alistador{
        color: var(--varosa-gris);
    }

    .alistador strong{
        color: var(--varosa-azul-oscuro);
    }

    .powered{
        font-size: 1.8mm;
        color: #94a3b8;
    }
</style>

</head>
<body>

<div class="controles">
    <div class="controles-header">
        <span class="logo-text">VAROSA</span>
        <h2>Sistema de Etiquetas</h2>
    </div>
    <p id="infoPagina">üì¶ Se generar√° una etiqueta por cada bulto de la orden.</p>
    <div>
        <button onclick="window.print()">üñ®Ô∏è Imprimir Etiquetas</button>
    </div>
    <div class="config-box">
        <strong>‚öôÔ∏è Configuraci√≥n de impresi√≥n:</strong><br>
        Tama√±o = User defined (101.6 √ó 50.8 mm) ¬∑ M√°rgenes = Ninguno ¬∑ Escala = 100%
    </div>
</div>

<div id="etiquetasContainer" class="etiquetas-container"></div>

<script>
    // ==== MAPEO DE USUARIOS ====
    const mapeoUsuarios = {
        "auxiliarbodegavarosa": "Anthony Nu√±ez",
        "auxiliarbodegavarosa1": "Andr√©s Ot√©ro",
        "auxiliarbodegavarosa2": "Orlando Contreras",
        "auxiliarbodegavarosa3": "Michael Arce",
        "luisrodrguezjimnez1": "Luis Rodr√≠guez Jim√©nez"
    };

    function obtenerNombreUsuario(username) {
        if (!username) return "Sin asignar";
        const key = username.trim().toLowerCase();
        for (const [u, nombre] of Object.entries(mapeoUsuarios)) {
            if (key === u.toLowerCase() || key.includes(u.toLowerCase())) {
                return nombre;
            }
        }
        return username;
    }

    // ==== CREAR ETIQUETA ====
    function crearEtiqueta(datos, nroBulto) {
        const notasClass = datos.notas ? '' : 'hidden';
        const notasHTML = datos.notas ? `‚ö†Ô∏è ${datos.notas}` : '';

        return `
        <div class="etiqueta-wrapper">
            <div class="etiqueta-label">üì¶ Etiqueta ${nroBulto} de ${datos.totalBultos} ‚Äî ${datos.documento}</div>
            <div class="etiqueta">

                <div class="header">
                    <div class="header-left">
                        <div class="empresa">VAROSA</div>
                        <div class="documento">${datos.documento}</div>
                        <div class="fecha-hora">${datos.fecha} ¬∑ ${datos.hora}</div>
                    </div>
                    <div class="header-right">
                        <div class="bultos-box">
                            <div class="bulto-item">
                                <small>BULTO</small>
                                <div class="numero">${nroBulto}</div>
                            </div>
                            <div class="bulto-item">
                                <small>DE</small>
                                <div class="numero">${datos.totalBultos}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="body">
                    <div class="info">
                        <div>
                            <div class="campo">
                                <div class="campo-label">Cliente</div>
                                <div class="campo-valor cliente">${datos.cliente}</div>
                            </div>
                            <div class="campo">
                                <div class="campo-label">Ruta de entrega</div>
                                <div class="campo-valor ruta">${datos.ruta}</div>
                            </div>
                        </div>
                        <div class="notas ${notasClass}">${notasHTML}</div>
                    </div>
                    <div class="qr-section">
                        <div class="qr-code" id="qr-${nroBulto}"></div>
                        <div class="qr-text">Escanear</div>
                    </div>
                </div>

                <div class="footer">
                    <div class="alistador">Alist√≥: <strong>${datos.alistador}</strong></div>
                    <div class="powered">varosa.cr</div>
                </div>

            </div>
        </div>`;
    }

    // ==== GENERAR QR ====
    function generarQR(elementId, datos, nroBulto) {
        const qrData = JSON.stringify({
            ov: datos.documento,
            b: `${nroBulto}/${datos.totalBultos}`,
            c: datos.cliente.substring(0, 30),
            r: datos.ruta.substring(0, 20)
        });

        const element = document.getElementById(elementId);
        if (element) {
            new QRCode(element, {
                text: qrData,
                width: 80,
                height: 80,
                colorDark: "#1a365d",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });
        }
    }

    // ==== GENERAR TODAS LAS ETIQUETAS ====
    function generarEtiquetas(datos) {
        const container = document.getElementById("etiquetasContainer");
        container.innerHTML = "";

        for (let i = 1; i <= datos.totalBultos; i++) {
            container.insertAdjacentHTML("beforeend", crearEtiqueta(datos, i));
        }

        // Generar QRs despu√©s de insertar el HTML
        setTimeout(() => {
            for (let i = 1; i <= datos.totalBultos; i++) {
                generarQR(`qr-${i}`, datos, i);
            }
        }, 100);

        // Actualizar info
        const bultoText = datos.totalBultos === 1 ? 'etiqueta' : 'etiquetas';
        document.getElementById("infoPagina").innerHTML =
            `üì¶ <strong>${datos.totalBultos}</strong> ${bultoText} para: <strong>${datos.cliente}</strong>`;
    }

    // ==== CARGAR DESDE URL ====
    function cargarDesdeURL() {
        const p = new URLSearchParams(window.location.search);

        // Si no hay par√°metros, cargar demo
        if (!p.has("ov")) {
            generarEtiquetas({
                documento: "SO-08194",
                fecha: "09/12/2025",
                hora: "07:15 p.m.",
                ruta: "FORTUNA - CASTILLO",
                cliente: "NAYARA HOTELS SRL",
                notas: "",
                alistador: obtenerNombreUsuario("auxiliarbodegavarosa1"),
                totalBultos: 2
            });
            return;
        }

        // Obtener fecha/hora actual si no viene en URL
        const ahora = new Date();
        const fechaDefault = ahora.toLocaleDateString('es-CR');
        const horaDefault = ahora.toLocaleTimeString('es-CR', {
            hour: '2-digit',
            minute: '2-digit'
        });

        const total = parseInt(p.get("bultos") || "1", 10);
        const alistadorRaw = p.get("alistador") || p.get("user") || "";

        const datos = {
            documento: p.get("ov") || "",
            fecha: p.get("fecha") || fechaDefault,
            hora: p.get("hora") || horaDefault,
            ruta: p.get("ruta") || "",
            cliente: p.get("cliente") || "",
            notas: p.get("notas") || "",
            alistador: obtenerNombreUsuario(alistadorRaw),
            totalBultos: isNaN(total) ? 1 : total
        };

        generarEtiquetas(datos);
    }

    document.addEventListener("DOMContentLoaded", cargarDesdeURL);
</script>

</body>
</html>
