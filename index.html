<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Etiquetas VAROSA</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
    :root{
        --label-width: 101.6mm;
        --label-height: 50.8mm;
        --padding: 2mm;
    }

    @page{
        size: var(--label-width) var(--label-height);
        margin: 0;
    }

    *{
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    html, body{
        width: 100%;
        height: 100%;
        font-family: Arial, Helvetica, sans-serif;
    }

    /* ======== SOLO PANTALLA ======== */
    @media screen{
        body{
            background: #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .controles{
            background: #fff;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,.15);
            margin-bottom: 20px;
            max-width: 500px;
            width: 100%;
        }
        .controles h2{
            margin-bottom: 6px;
            font-size: 18px;
        }
        .controles p{
            font-size: 13px;
            color: #4b5563;
            margin-bottom: 12px;
        }
        .controles button{
            background: #2563eb;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
        }
        .controles button:hover{
            background: #1d4ed8;
        }
        .config-box{
            font-size: 11px;
            margin-top: 12px;
            background: #ecfdf5;
            padding: 8px 10px;
            border-radius: 5px;
            border-left: 3px solid #10b981;
        }
        .etiquetas-container{
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        .etiqueta-wrapper{
            box-shadow: 0 4px 15px rgba(0,0,0,.2);
            background: #fff;
            border-radius: 6px;
            overflow: hidden;
        }
        .etiqueta-label{
            background: #fef3c7;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: bold;
            color: #92400e;
            text-align: center;
        }
    }

    /* ======== SOLO IMPRESI√ìN ======== */
    @media print{
        body{
            background: #fff !important;
            padding: 0;
        }
        .controles,
        .etiqueta-label{
            display: none !important;
        }
        .etiquetas-container{
            display: block;
        }
        .etiqueta-wrapper{
            width: var(--label-width);
            height: var(--label-height);
            page-break-after: always;
            box-shadow: none;
        }
        .etiqueta-wrapper:last-child{
            page-break-after: avoid;
        }
    }

    /* ======== DISE√ëO DE LA ETIQUETA ======== */
    .etiqueta{
        width: var(--label-width);
        height: var(--label-height);
        padding: var(--padding);
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    /* Header: VAROSA + DOC + FECHA */
    .header{
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-bottom: 1.5mm;
        border-bottom: 0.4mm solid #000;
        margin-bottom: 1.5mm;
    }

    .header-left{
        display: flex;
        flex-direction: column;
    }

    .empresa{
        font-size: 5mm;
        font-weight: bold;
        letter-spacing: 0.3mm;
    }

    .documento{
        font-size: 4mm;
        font-weight: bold;
        color: #1f2937;
    }

    .fecha-hora{
        font-size: 2.5mm;
        color: #6b7280;
        margin-top: 0.5mm;
    }

    .header-right{
        text-align: right;
    }

    .bultos-box{
        display: flex;
        gap: 1mm;
    }

    .bulto-item{
        border: 0.3mm solid #000;
        padding: 1mm 2mm;
        text-align: center;
        min-width: 10mm;
    }

    .bulto-item small{
        display: block;
        font-size: 2mm;
        color: #6b7280;
    }

    .bulto-item .numero{
        font-size: 4.5mm;
        font-weight: bold;
        line-height: 1;
    }

    /* Cuerpo: INFO + QR */
    .body{
        display: flex;
        flex: 1;
        gap: 2mm;
    }

    /* Lado izquierdo: datos */
    .info{
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-width: 0;
    }

    .campo{
        margin-bottom: 1mm;
    }

    .campo-label{
        font-size: 2.5mm;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.2mm;
    }

    .campo-valor{
        font-size: 3.2mm;
        font-weight: bold;
        color: #000;
        line-height: 1.2;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .campo-valor.cliente{
        font-size: 3.5mm;
    }

    .campo-valor.ruta{
        font-size: 3.2mm;
        background: #f3f4f6;
        padding: 0.8mm 1.5mm;
        border-radius: 1mm;
        display: inline-block;
    }

    .notas{
        font-size: 2.8mm;
        color: #dc2626;
        background: #fef2f2;
        padding: 1mm 2mm;
        border-radius: 1mm;
        border: 0.2mm solid #fecaca;
        margin-top: 1mm;
    }

    .notas.hidden{
        display: none;
    }

    /* Lado derecho: QR */
    .qr-section{
        width: 24mm;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-left: 0.3mm dashed #d1d5db;
        padding-left: 2mm;
    }

    .qr-code{
        width: 20mm;
        height: 20mm;
    }

    .qr-code img,
    .qr-code canvas{
        width: 100% !important;
        height: 100% !important;
    }

    .qr-text{
        font-size: 2mm;
        color: #9ca3af;
        margin-top: 1mm;
        text-align: center;
    }

    /* Footer: Alistador */
    .footer{
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 0.3mm solid #e5e7eb;
        padding-top: 1mm;
        margin-top: auto;
        font-size: 2.5mm;
    }

    .alistador{
        color: #374151;
    }

    .alistador strong{
        color: #000;
    }
</style>

</head>
<body>

<div class="controles">
    <h2>üè∑Ô∏è Etiquetas VAROSA</h2>
    <p id="infoPagina">Se generar√° una etiqueta por cada bulto.</p>
    <div>
        <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
    </div>
    <div class="config-box">
        <strong>‚öôÔ∏è Configuraci√≥n Chrome:</strong> 
        Tama√±o = User defined (101.6 √ó 50.8 mm) ¬∑ M√°rgenes = Ninguno ¬∑ Escala = 100%
    </div>
</div>

<div id="etiquetasContainer" class="etiquetas-container"></div>

<script>
    // ==== MAPEO DE USUARIOS ====
    const mapeoUsuarios = {
        "auxiliarbodegavarosa": "Anthony Nu√±ez",
        "auxiliarbodegavarosa1": "Andr√©s Ot√©ro",
        "auxiliarbodegavarosa2": "Orlando Contreras",
        "auxiliarbodegavarosa3": "Michael Arce",
        "luisrodrguezjimnez1": "Luis Rodr√≠guez Jim√©nez"
    };

    function obtenerNombreUsuario(username) {
        if (!username) return "Sin asignar";
        const key = username.trim().toLowerCase();
        for (const [u, nombre] of Object.entries(mapeoUsuarios)) {
            if (key === u.toLowerCase() || key.includes(u.toLowerCase())) {
                return nombre;
            }
        }
        return username;
    }

    // ==== CREAR ETIQUETA ====
    function crearEtiqueta(datos, nroBulto) {
        const notasClass = datos.notas ? '' : 'hidden';
        const notasHTML = datos.notas ? `‚ö†Ô∏è ${datos.notas}` : '';

        return `
        <div class="etiqueta-wrapper">
            <div class="etiqueta-label">üì¶ Etiqueta ${nroBulto} de ${datos.totalBultos}</div>
            <div class="etiqueta">
                
                <div class="header">
                    <div class="header-left">
                        <div class="empresa">VAROSA</div>
                        <div class="documento">${datos.documento}</div>
                        <div class="fecha-hora">${datos.fecha} ${datos.hora}</div>
                    </div>
                    <div class="header-right">
                        <div class="bultos-box">
                            <div class="bulto-item">
                                <small>BULTO</small>
                                <div class="numero">${nroBulto}</div>
                            </div>
                            <div class="bulto-item">
                                <small>DE</small>
                                <div class="numero">${datos.totalBultos}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="body">
                    <div class="info">
                        <div>
                            <div class="campo">
                                <div class="campo-label">Cliente</div>
                                <div class="campo-valor cliente">${datos.cliente}</div>
                            </div>
                            <div class="campo">
                                <div class="campo-label">Ruta</div>
                                <div class="campo-valor ruta">${datos.ruta}</div>
                            </div>
                        </div>
                        <div class="notas ${notasClass}">${notasHTML}</div>
                    </div>
                    <div class="qr-section">
                        <div class="qr-code" id="qr-${nroBulto}"></div>
                        <div class="qr-text">Escanear</div>
                    </div>
                </div>

                <div class="footer">
                    <div class="alistador">Alist√≥: <strong>${datos.alistador}</strong></div>
                </div>

            </div>
        </div>`;
    }

    // ==== GENERAR QR ====
    function generarQR(elementId, datos, nroBulto) {
        const qrData = JSON.stringify({
            ov: datos.documento,
            b: `${nroBulto}/${datos.totalBultos}`,
            c: datos.cliente.substring(0, 30),
            r: datos.ruta.substring(0, 20)
        });

        const element = document.getElementById(elementId);
        if (element) {
            new QRCode(element, {
                text: qrData,
                width: 80,
                height: 80,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });
        }
    }

    // ==== GENERAR TODAS LAS ETIQUETAS ====
    function generarEtiquetas(datos) {
        const container = document.getElementById("etiquetasContainer");
        container.innerHTML = "";

        for (let i = 1; i <= datos.totalBultos; i++) {
            container.insertAdjacentHTML("beforeend", crearEtiqueta(datos, i));
        }

        // Generar QRs despu√©s de insertar el HTML
        setTimeout(() => {
            for (let i = 1; i <= datos.totalBultos; i++) {
                generarQR(`qr-${i}`, datos, i);
            }
        }, 100);

        // Actualizar info
        document.getElementById("infoPagina").textContent = 
            `${datos.totalBultos} etiqueta(s) para: ${datos.cliente}`;
    }

    // ==== CARGAR DESDE URL ====
    function cargarDesdeURL() {
        const p = new URLSearchParams(window.location.search);

        // Si no hay par√°metros, cargar demo
        if (!p.has("ov")) {
            generarEtiquetas({
                documento: "SO-08194",
                fecha: "09/12/2025",
                hora: "07:15 p.m.",
                ruta: "FORTUNA - CASTILLO",
                cliente: "NAYARA HOTELS SRL",
                notas: "",
                alistador: obtenerNombreUsuario("auxiliarbodegavarosa1"),
                totalBultos: 2
            });
            return;
        }

        // Obtener fecha/hora actual si no viene en URL
        const ahora = new Date();
        const fechaDefault = ahora.toLocaleDateString('es-CR');
        const horaDefault = ahora.toLocaleTimeString('es-CR', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });

        const total = parseInt(p.get("bultos") || "1", 10);
        const alistadorRaw = p.get("alistador") || p.get("user") || "";

        const datos = {
            documento: p.get("ov") || "",
            fecha: p.get("fecha") || fechaDefault,
            hora: p.get("hora") || horaDefault,
            ruta: p.get("ruta") || "",
            cliente: p.get("cliente") || "",
            notas: p.get("notas") || "",
            alistador: obtenerNombreUsuario(alistadorRaw),
            totalBultos: isNaN(total) ? 1 : total
        };

        generarEtiquetas(datos);
    }

    document.addEventListener("DOMContentLoaded", cargarDesdeURL);
</script>

</body>
</html>
