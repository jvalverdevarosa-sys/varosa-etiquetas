<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Etiquetas VAROSA</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
    :root{
        --label-width: 101.6mm;
        --label-height: 50.8mm;
        --padding: 2mm;
        --label-top-safe: 2mm;
    }

    @page{
        size: var(--label-width) var(--label-height);
        margin: 0;
    }

    *{
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    html, body{
        width: 100%;
        height: 100%;
        font-family: 'Segoe UI', Arial, Helvetica, sans-serif;
    }

    @media screen{
        body{
            background: #0f172a;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .controles{
            background: #fff;
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,.2);
            margin-bottom: 24px;
            max-width: 520px;
            width: 100%;
        }
        .controles-header{
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .logo-text{
            font-size: 24px;
            font-weight: 800;
        }
        .controles h2{
            font-size: 16px;
            font-weight: 700;
        }
        .controles p{
            font-size: 13px;
            margin-bottom: 16px;
            padding: 10px 12px;
            background: #f1f5f9;
            border-radius: 8px;
        }
        .controles button{
            background: #000;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
        }
        .config-box{
            font-size: 11px;
            margin-top: 16px;
            background: #e5e7eb;
            padding: 10px 12px;
            border-radius: 8px;
            font-weight: 700;
        }
        .etiquetas-container{
            display: flex;
            flex-direction: column;
            gap: 24px;
            align-items: center;
        }
        .etiqueta-wrapper{
            box-shadow: 0 8px 30px rgba(0,0,0,.25);
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        .etiqueta-label{
            background: #000;
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            text-align: center;
        }
    }

    @media print{
        body{
            background: #fff !important;
            padding: 0;
        }
        .controles,
        .etiqueta-label{
            display: none !important;
        }
        .etiquetas-container{
            display: block;
        }
        .etiqueta-wrapper{
            width: var(--label-width);
            height: var(--label-height);
            page-break-after: always;
            box-shadow: none !important;
            margin: 0;
            padding: 0;
        }
        .etiqueta-wrapper:last-child{
            page-break-after: avoid;
        }
    }

    .etiqueta{
        width: var(--label-width);
        height: var(--label-height);
        padding: var(--padding);
        padding-top: calc(var(--padding) + var(--label-top-safe));
        display: flex;
        flex-direction: column;
        background: #fff;
        color: #000;
        font-weight: 700;
    }

    .header{
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-bottom: 0.8mm;
        border-bottom: 0.4mm solid #000;
        margin-bottom: 0.8mm;
    }

    .header-left{
        display: flex;
        flex-direction: column;
    }

    .empresa{
        font-size: 5mm;
        font-weight: 800;
        color: #000;
        letter-spacing: 0.5mm;
    }

    .documento{
        font-size: 4mm;
        font-weight: 800;
        color: #000;
    }

    .fecha-hora{
        font-size: 2.4mm;
        color: #000;
        margin-top: 0.3mm;
        font-weight: 700;
    }

    .header-right{
        text-align: right;
    }

    .bultos-box{
        display: flex;
        gap: 0;
    }

    .bulto-item{
        border: 0.3mm solid #000;
        padding: 0.8mm 2mm;
        text-align: center;
        min-width: 11mm;
        background: #fff;
        font-weight: 700;
    }

    .bulto-item:first-child{
        border-right: none;
        border-radius: 1mm 0 0 1mm;
    }

    .bulto-item:last-child{
        border-radius: 0 1mm 1mm 0;
        background: #fff;
    }

    .bulto-item small{
        display: block;
        font-size: 1.9mm;
        color: #000;
        font-weight: 700;
    }

    .bulto-item .numero{
        font-size: 5mm;
        font-weight: 800;
        line-height: 1;
        color: #000;
    }

    .body{
        display: flex;
        flex: 1;
        gap: 2mm;
    }

    .info{
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-width: 0;
    }

    .campo{
        margin-bottom: 0.6mm;
    }

    .campo-label{
        font-size: 2.3mm;
        color: #000;
        text-transform: uppercase;
        letter-spacing: 0.3mm;
        font-weight: 700;
    }

    .campo-valor{
        font-size: 3.2mm;
        font-weight: 700;
        color: #000;
        line-height: 1.25;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .campo-valor.cliente{
        font-size: 3.5mm;
        font-weight: 800;
    }

    .campo-valor.ruta{
        font-size: 3mm;
        background: #fff;
        color: #000;
        padding: 0.6mm 2mm;
        border-radius: 1mm;
        border: 0.3mm solid #000;
        display: inline-block;
        font-weight: 800;
    }

    .notas{
        font-size: 2.7mm;
        color: #000;
        background: #fff;
        padding: 0.8mm 2mm;
        border-radius: 0;
        border-left: 0.3mm solid #000;
        margin-top: 0.5mm;
        font-weight: 700;
    }

    .notas.hidden{
        display: none;
    }

    .qr-section{
        width: 24mm;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-left: 0.3mm dashed #000;
        padding-left: 2mm;
    }

    .qr-code{
        width: 20mm;
        height: 20mm;
    }

    .qr-code img,
    .qr-code canvas{
        width: 100% !important;
        height: 100% !important;
    }

    .qr-text{
        font-size: 2mm;
        color: #000;
        margin-top: 0.8mm;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.2mm;
        font-weight: 700;
    }

    .footer{
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 0.3mm solid #000;
        padding-top: 0.6mm;
        margin-top: 0.6mm;
        font-size: 2.5mm;
    }

    .alistador{
        color: #000;
        font-weight: 700;
    }

    .alistador strong{
        color: #000;
        font-weight: 800;
    }

    .powered{
        font-size: 2mm;
        color: #000;
        font-weight: 700;
    }
</style>
</head>

<body>

<div class="controles">
    <div class="controles-header">
        <span class="logo-text">VAROSA</span>
        <h2>Sistema de Etiquetas</h2>
    </div>
    <p id="infoPagina">üì¶ Se generar√° una etiqueta por cada bulto de la orden.</p>
    <div>
        <button onclick="window.print()">üñ®Ô∏è Imprimir Etiquetas</button>
    </div>
    <div class="config-box">
        <strong>‚öôÔ∏è Configuraci√≥n de impresi√≥n:</strong><br>
        Tama√±o = User defined (101.6 √ó 50.8 mm) ¬∑ M√°rgenes = Ninguno ¬∑ Escala = 100%
    </div>
</div>

<div id="etiquetasContainer" class="etiquetas-container"></div>

<script>
    // ==== MAPEO DE USUARIOS ====
    const mapeoUsuarios = {
        "auxiliarbodegavarosa":  "Anthony Nu√±ez",
        "auxiliarbodegavarosa1": "Andr√©s Ot√©ro",
        "auxiliarbodegavarosa2": "Orlando Contreras",
        "auxiliarbodegavarosa3": "Michael Arce",
        "luisrodrguezjimnez1":   "Luis Rodr√≠guez Jim√©nez"
    };

    function obtenerNombreUsuario(username) {
        if (!username) return "Sin asignar";
        const key = username.trim().toLowerCase().split('@')[0];
        if (mapeoUsuarios[key]) {
            return mapeoUsuarios[key];
        }
        if (username.includes(" ")) {
            return username;
        }
        return "Sin asignar";
    }

    // ==== CREAR ETIQUETA ====
    function crearEtiqueta(datos, nroBulto) {
        const notasClass = datos.notas ? '' : 'hidden';
        const notasHTML = datos.notas ? `‚ö†Ô∏è ${datos.notas}` : '';

        return `
        <div class="etiqueta-wrapper">
            <div class="etiqueta-label">Etiqueta ${nroBulto} de ${datos.totalBultos} ‚Äî ${datos.documento}</div>
            <div class="etiqueta">

                <div class="header">
                    <div class="header-left">
                        <div class="empresa">VAROSA</div>
                        <div class="documento">${datos.documento}</div>
                        <div class="fecha-hora">${datos.fecha} ¬∑ ${datos.hora}</div>
                    </div>
                    <div class="header-right">
                        <div class="bultos-box">
                            <div class="bulto-item">
                                <small>BULTO</small>
                                <div class="numero">${nroBulto}</div>
                            </div>
                            <div class="bulto-item">
                                <small>DE</small>
                                <div class="numero">${datos.totalBultos}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="body">
                    <div class="info">
                        <div>
                            <div class="campo">
                                <div class="campo-label">Cliente</div>
                                <div class="campo-valor cliente">${datos.cliente}</div>
                            </div>
                            <div class="campo">
                                <div class="campo-label">Ruta de entrega</div>
                                <div class="campo-valor ruta">${datos.ruta}</div>
                            </div>
                        </div>
                        <div class="notas ${notasClass}">${notasHTML}</div>
                    </div>
                    <div class="qr-section">
                        <div class="qr-code" id="qr-${nroBulto}"></div>
                        <div class="qr-text">Escanear</div>
                    </div>
                </div>

                <div class="footer">
                    <div class="alistador">Alist√≥: <strong>${datos.alistador}</strong></div>
                    <div class="powered">varosa.cr</div>
                </div>

            </div>
        </div>`;
    }

    // ==== GENERAR QR (formato compatible con factura) ====
    function generarQR(elementId, datos, nroBulto) {
        // Formato compatible con QR de factura Books
        // $OV:id $R:ruta $A:alistador $B:bulto/total
        const qrData = `$OV:${datos.ovId} $R:${datos.ruta} $A:${datos.alistadorUsername} $B:${nroBulto}/${datos.totalBultos}`;

        const element = document.getElementById(elementId);
        if (element) {
            new QRCode(element, {
                text: qrData,
                width: 80,
                height: 80,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });
        }
    }

    // ==== GENERAR TODAS LAS ETIQUETAS ====
    function generarEtiquetas(datos) {
        const container = document.getElementById("etiquetasContainer");
        container.innerHTML = "";

        for (let i = 1; i <= datos.totalBultos; i++) {
            container.insertAdjacentHTML("beforeend", crearEtiqueta(datos, i));
        }

        setTimeout(() => {
            for (let i = 1; i <= datos.totalBultos; i++) {
                generarQR(`qr-${i}`, datos, i);
            }
        }, 100);

        const bultoText = datos.totalBultos === 1 ? 'etiqueta' : 'etiquetas';
        document.getElementById("infoPagina").innerHTML =
            `üì¶ <strong>${datos.totalBultos}</strong> ${bultoText} para: <strong>${datos.cliente}</strong>`;
    }

    // ==== CARGAR DESDE URL ====
    function cargarDesdeURL() {
        const p = new URLSearchParams(window.location.search);

        if (!p.has("ov")) {
            // Demo por si se abre sin par√°metros
            generarEtiquetas({
                documento: "SO-08194",
                fecha: "09/12/2025",
                hora: "07:15 p.m.",
                ruta: "FORTUNA - CASTILLO",
                cliente: "NAYARA HOTELS SRL",
                notas: "",
                alistador: obtenerNombreUsuario("auxiliarbodegavarosa1"),
                alistadorUsername: "auxiliarbodegavarosa1",
                totalBultos: 2,
                ovId: "4809466000000261034" // ID de Creator (demo)
            });
            return;
        }

        const ahora = new Date();
        const fechaDefault = ahora.toLocaleDateString('es-CR');
        const horaDefault = ahora.toLocaleTimeString('es-CR', {
            hour: '2-digit',
            minute: '2-digit'
        });

        const total = parseInt(p.get("bultos") || "1", 10);
        const alistadorRaw = p.get("alistador") || p.get("user") || "";

        const datos = {
            documento: p.get("ov") || "",
            fecha: p.get("fecha") || fechaDefault,
            hora: p.get("hora") || horaDefault,
            ruta: p.get("ruta") || "",
            cliente: p.get("cliente") || "",
            notas: p.get("notas") || "",
            alistador: obtenerNombreUsuario(alistadorRaw),
            alistadorUsername: alistadorRaw, // Username original para el QR
            totalBultos: isNaN(total) ? 1 : total,
            ovId: p.get("ov_id") || "" // ID de Creator para trazabilidad
        };

        generarEtiquetas(datos);
    }

    document.addEventListener("DOMContentLoaded", cargarDesdeURL);
</script>

</body>
</html>
