<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAROSA - Imprimir Etiquetas</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #1a1a2e; color: #fff; min-height: 100vh; }
        
        /* ===== PANTALLA ===== */
        .screen-only { padding: 2rem; max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 0.5rem; color: #4ecdc4; }
        .subtitle { text-align: center; color: #888; margin-bottom: 2rem; }
        .order-info { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .order-info-item { display: flex; flex-direction: column; }
        .order-info-label { font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 0.25rem; }
        .order-info-value { font-size: 1.1rem; font-weight: 600; }
        .preview-container { background: #fff; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; }
        .preview-title { color: #333; font-size: 0.9rem; margin-bottom: 1rem; text-align: center; }
        .labels-preview { display: flex; flex-direction: column; gap: 1.5rem; align-items: center; }
        .print-actions { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 1rem 2rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #4ecdc4; color: #000; }
        .btn-primary:hover { background: #3dbdb5; transform: translateY(-2px); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .instructions { background: rgba(78, 205, 196, 0.1); border: 1px solid rgba(78, 205, 196, 0.3); border-radius: 8px; padding: 1rem; margin-top: 2rem; }
        .instructions h3 { color: #4ecdc4; margin-bottom: 0.5rem; }
        .instructions ol { margin-left: 1.5rem; color: #aaa; }
        .instructions li { margin-bottom: 0.5rem; }
        .config-note { background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .config-note h4 { color: #ffc107; margin-bottom: 0.5rem; }
        .config-note ul { margin-left: 1.5rem; color: #aaa; font-size: 0.9rem; }

        /* ===== ETIQUETA: 101.6mm x 50.8mm (4" x 2") horizontal ===== */
        .label {
            width: 384px;      /* ~101.6mm en pantalla */
            height: 192px;     /* ~50.8mm en pantalla */
            background: #fff;
            color: #000;
            font-family: Arial, sans-serif;
            border: 1px solid #000;
            display: flex;
            flex-direction: row;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        /* Secci√≥n QR - izquierda */
        .qr-section {
            width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 2px solid #000;
            background: #fff;
            padding: 8px;
        }
        .qr-image { width: 80px; height: 80px; }
        .qr-label { font-size: 8px; color: #666; margin-top: 4px; text-transform: uppercase; font-weight: bold; }

        /* Secci√≥n principal - centro */
        .main-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 8px 12px;
            justify-content: space-between;
        }

        /* Header: VAROSA | OV | Ruta */
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #000;
            padding-bottom: 6px;
            margin-bottom: 6px;
        }
        .logo { font-weight: 900; font-size: 16px; letter-spacing: 2px; }
        .ov-num { 
            font-weight: bold; 
            font-size: 14px; 
            border: 2px solid #000; 
            padding: 2px 8px;
            background: #fff;
            color: #000;
        }
        .ruta-badge { 
            font-size: 11px; 
            font-weight: bold; 
            background: #e0e0e0; 
            padding: 3px 8px; 
            border-radius: 4px;
            max-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Cliente - permite m√∫ltiples l√≠neas */
        .cliente-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .cliente-label { 
            font-size: 9px; 
            color: #666; 
            text-transform: uppercase; 
            margin-bottom: 2px;
        }
        .cliente-value { 
            font-size: 14px; 
            font-weight: bold; 
            line-height: 1.2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Notas */
        .notas-row { 
            font-size: 10px; 
            color: #333; 
            font-style: italic;
            padding: 4px 0;
            border-top: 1px dashed #ccc;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Alistador */
        .alistador-row {
            font-size: 8px;
            color: #666;
            margin-top: 2px;
        }

        /* Secci√≥n Bulto - derecha */
        .bulto-section {
            width: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-left: 2px solid #000;
            background: #f5f5f5;
            padding: 8px;
        }
        .bulto-label { 
            font-size: 10px; 
            color: #666; 
            text-transform: uppercase; 
            margin-bottom: 6px;
            font-weight: bold;
        }
        .bulto-display { 
            display: flex; 
            align-items: center; 
            gap: 4px; 
        }
        .bulto-box { 
            border: 3px solid #000; 
            padding: 4px 10px; 
            font-size: 28px; 
            font-weight: 900; 
            text-align: center; 
            min-width: 36px; 
            background: #fff; 
        }
        .bulto-de { font-size: 16px; font-weight: bold; }

        /* ===== IMPRESI√ìN ===== */
        @media print {
            .screen-only { display: none !important; }
            
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                background: #fff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .print-container { 
                display: block !important;
                margin: 0;
                padding: 0;
            }

            .label {
                width: 101.6mm;
                height: 50.8mm;
                margin: 0;
                padding: 0;
                border: none;
                page-break-after: always;
                break-after: page;
            }
            .label:last-child {
                page-break-after: avoid;
                break-after: avoid;
            }

            .qr-section { 
                width: 26mm; 
                border-right: 1px solid #000;
            }
            .qr-image { width: 20mm; height: 20mm; }
            
            .bulto-section { 
                width: 24mm;
                border-left: 1px solid #000;
            }
            
            .logo { font-size: 12pt; }
            .ov-num { font-size: 11pt; border-width: 1px; }
            .ruta-badge { font-size: 9pt; }
            .cliente-value { font-size: 11pt; }
            .notas-row { font-size: 8pt; }
            .bulto-box { font-size: 22pt; border-width: 2px; padding: 2px 6px; }
            .bulto-de { font-size: 12pt; }

            @page {
                size: 101.6mm 50.8mm;
                margin: 0;
            }
        }

        .print-container { display: none; }
        .error-message { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 2rem; text-align: center; color: #ef4444; }
        
        .debug-info { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem; margin-top: 1rem; font-size: 0.75rem; color: #888; }
        .debug-info summary { cursor: pointer; color: #4ecdc4; }
        .debug-info pre { margin-top: 0.5rem; white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body>
    <div class="screen-only">
        <h1>üñ®Ô∏è Imprimir Etiquetas de Alisto</h1>
        <p class="subtitle">Vista previa antes de imprimir</p>
        <div id="content-area"></div>
    </div>
    <div class="print-container" id="print-container"></div>

    <script>
        function getUrlParams() {
            var params = new URLSearchParams(window.location.search);
            return {
                ov: params.get('ov') || '',
                ov_id: params.get('ov_id') || '',
                cliente: params.get('cliente') || '',
                ruta: params.get('ruta') || '',
                notas: params.get('notas') || '',
                cantidad_bultos: parseInt(params.get('bultos')) || 0,
                alistador: params.get('alistador') || ''
            };
        }

        var orderData = getUrlParams();

        if (!orderData.ov) {
            orderData = {
                ov: "SO-08136",
                ov_id: "6074712000025165467",
                cliente: "JUNTA DE EDUCACION ESCUELA EL JARDIN LA TRINCHERA",
                ruta: "VENECIA - RIO CUARTO",
                notas: "NO FACTURAR - ES UN PENDIENTE DE ENTREGA",
                cantidad_bultos: 2,
                alistador: "Carlos Mora"
            };
        }

        function getTimestamp() {
            return new Date().toISOString();
        }

        function createQRData(bulto, total) {
            return {
                t: "E",
                ov: orderData.ov,
                ov_id: orderData.ov_id,
                b: bulto,
                tb: total,
                cli: orderData.cliente,
                ruta: orderData.ruta,
                alistador: orderData.alistador,
                ts: getTimestamp()
            };
        }

        function getQRUrl(qrData) {
            var jsonString = JSON.stringify(qrData);
            return 'https://quickchart.io/qr?text=' + encodeURIComponent(jsonString) + '&size=200&margin=1';
        }

        function formatRuta(ruta) {
            if (ruta.length > 15) {
                return ruta.substring(0, 15) + '...';
            }
            return ruta;
        }

        function createLabel(bulto, total) {
            var qrData = createQRData(bulto, total);
            var notasHtml = orderData.notas ? '<div class="notas-row">üìù ' + orderData.notas + '</div>' : '';
            var alistadorHtml = orderData.alistador ? '<div class="alistador-row">‚úì Alist√≥: ' + orderData.alistador + '</div>' : '';
            
            return '<div class="label">' +
                '<div class="qr-section">' +
                    '<img class="qr-image" src="' + getQRUrl(qrData) + '" alt="QR">' +
                    '<span class="qr-label">Escanear</span>' +
                '</div>' +
                '<div class="main-section">' +
                    '<div class="header-row">' +
                        '<span class="logo">VAROSA</span>' +
                        '<span class="ov-num">' + orderData.ov + '</span>' +
                        '<span class="ruta-badge">üìç ' + formatRuta(orderData.ruta) + '</span>' +
                    '</div>' +
                    '<div class="cliente-section">' +
                        '<span class="cliente-label">Cliente:</span>' +
                        '<span class="cliente-value">' + orderData.cliente + '</span>' +
                    '</div>' +
                    notasHtml +
                    alistadorHtml +
                '</div>' +
                '<div class="bulto-section">' +
                    '<span class="bulto-label">Bulto</span>' +
                    '<div class="bulto-display">' +
                        '<div class="bulto-box">' + bulto + '</div>' +
                        '<span class="bulto-de">/</span>' +
                        '<div class="bulto-box">' + total + '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        function init() {
            var contentArea = document.getElementById('content-area');
            var printContainer = document.getElementById('print-container');

            if (orderData.cantidad_bultos < 1) {
                contentArea.innerHTML = '<div class="error-message"><h2>‚ö†Ô∏è Error</h2><p>No se especific√≥ cantidad de bultos.</p></div>';
                return;
            }

            var labelsHtml = '';
            for (var i = 1; i <= orderData.cantidad_bultos; i++) {
                labelsHtml += createLabel(i, orderData.cantidad_bultos);
            }

            var sampleQRData = createQRData(1, orderData.cantidad_bultos);

            contentArea.innerHTML = 
                '<div class="order-info">' +
                    '<div class="order-info-item"><span class="order-info-label">Orden</span><span class="order-info-value">' + orderData.ov + '</span></div>' +
                    '<div class="order-info-item"><span class="order-info-label">Cliente</span><span class="order-info-value">' + orderData.cliente + '</span></div>' +
                    '<div class="order-info-item"><span class="order-info-label">Ruta</span><span class="order-info-value">' + orderData.ruta + '</span></div>' +
                    '<div class="order-info-item"><span class="order-info-label">Bultos</span><span class="order-info-value" style="color:#4ecdc4;font-size:1.5rem">' + orderData.cantidad_bultos + '</span></div>' +
                    '<div class="order-info-item"><span class="order-info-label">Alistado por</span><span class="order-info-value" style="color:#a78bfa">' + (orderData.alistador || 'No especificado') + '</span></div>' +
                    (orderData.notas ? '<div class="order-info-item" style="grid-column:1/-1"><span class="order-info-label">Notas</span><span class="order-info-value" style="color:#ffa500">' + orderData.notas + '</span></div>' : '') +
                '</div>' +
                '<div class="preview-container">' +
                    '<div class="preview-title">Vista previa de ' + orderData.cantidad_bultos + ' etiqueta(s) - Tama√±o: 101.6mm x 50.8mm (4" x 2")</div>' +
                    '<div class="labels-preview">' + labelsHtml + '</div>' +
                '</div>' +
                '<div class="print-actions">' +
                    '<button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir</button>' +
                    '<button class="btn btn-secondary" onclick="window.close()">‚úï Cerrar</button>' +
                '</div>' +
                '<div class="config-note"><h4>‚öôÔ∏è Configuraci√≥n de impresi√≥n IMPORTANTE:</h4><ul>' +
                    '<li><strong>Tama√±o del papel:</strong> Custom 101.6mm x 50.8mm (o seleccionar 2x4 en SATO)</li>' +
                    '<li><strong>M√°rgenes:</strong> Ninguno</li>' +
                    '<li><strong>Escala:</strong> 100% (NO usar "Ajustar a p√°gina")</li>' +
                    '<li><strong>Encabezados y pies:</strong> Desactivado ‚úì</li>' +
                    '<li><strong>P√°ginas esperadas:</strong> ' + orderData.cantidad_bultos + '</li>' +
                '</ul></div>' +
                '<div class="instructions"><h3>üìã Verificar antes de imprimir</h3><ol>' +
                    '<li>Impresora SATO encendida y con etiquetas cargadas</li>' +
                    '<li>Seleccionar tama√±o "2 x 4" o "USER" si configuraron custom</li>' +
                    '<li>Si muestra m√°s p√°ginas de las esperadas, usar "Cuadro de di√°logo del sistema" (Ctrl+Shift+P)</li>' +
                '</ol></div>' +
                '<details class="debug-info"><summary>üîç Ver contenido del QR (debug)</summary>' +
                    '<pre>' + JSON.stringify(sampleQRData, null, 2) + '</pre>' +
                '</details>';

            printContainer.innerHTML = labelsHtml;
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
